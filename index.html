<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>听书工具</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      max-width: 600px;
      margin: auto;
    }
    h1 { text-align: center; }
    #controls button {
      margin: 0.5em 0.5em 0.5em 0;
      padding: 0.5em 1em;
      font-size: 1em;
    }
    textarea {
      width: 100%;
      height: 150px;
    }
    #chapterSelect {
      width: 100%;
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <h1>📖 听书工具</h1>
  <input type="file" id="fileInput" accept=".txt" />
  <select id="chapterSelect"></select>
  <textarea id="textDisplay" readonly></textarea>
  <div id="controls">
    <button onclick="speak()">▶ 播放</button>
    <button onclick="pause()">⏸ 暂停</button>
    <button onclick="resume()">▶ 继续</button>
    <button onclick="nextParagraph()">⏭ 下一段</button>
  </div>

  <script>
    let chapters = [];
    let currentChapter = 0;
    let currentParagraph = 0;
    let utterance;

    function speak() {
      const text = chapters[currentChapter].paragraphs[currentParagraph];
      if (!text) return;
      stop();
      utterance = new SpeechSynthesisUtterance(text);
      utterance.onend = () => {
        currentParagraph++;
        saveProgress();
        if (currentParagraph < chapters[currentChapter].paragraphs.length) {
          speak();
        }
      };
      speechSynthesis.speak(utterance);
      document.getElementById("textDisplay").value = text;
    }

    function pause() {
      speechSynthesis.pause();
    }

    function resume() {
      speechSynthesis.resume();
    }

    function stop() {
      speechSynthesis.cancel();
    }

    function nextParagraph() {
      stop();
      currentParagraph++;
      if (currentParagraph >= chapters[currentChapter].paragraphs.length) {
        currentParagraph = chapters[currentChapter].paragraphs.length - 1;
      }
      speak();
    }

    function saveProgress() {
      const progress = { chapter: currentChapter, paragraph: currentParagraph };
      localStorage.setItem("audiobook_progress", JSON.stringify(progress));
    }

    function loadProgress() {
      const saved = localStorage.getItem("audiobook_progress");
      if (saved) {
        const { chapter, paragraph } = JSON.parse(saved);
        currentChapter = chapter;
        currentParagraph = paragraph;
        document.getElementById("chapterSelect").selectedIndex = currentChapter;
      }
    }

    function loadChapters(content) {
      const lines = content.split(/\r?\n/);
      let current = { title: "开始", paragraphs: [] };
      chapters = [];
      lines.forEach(line => {
        if (/第.{1,9}[章回节]/.test(line)) {
          if (current.paragraphs.length > 0) chapters.push(current);
          current = { title: line.trim(), paragraphs: [] };
        } else if (line.trim()) {
          current.paragraphs.push(line.trim());
        }
      });
      if (current.paragraphs.length > 0) chapters.push(current);

      const select = document.getElementById("chapterSelect");
      select.innerHTML = "";
      chapters.forEach((c, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = c.title;
        select.appendChild(opt);
      });

      select.onchange = () => {
        stop();
        currentChapter = parseInt(select.value);
        currentParagraph = 0;
        saveProgress();
        speak();
      };

      loadProgress();
      speak();
    }

    document.getElementById("fileInput").addEventListener("change", e => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = () => loadChapters(reader.result);
      reader.readAsText(file);
    });
  </script>
</body>
</html>
