<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>听书小助手</title>
  <style>
    /* ... 样式同前，略 ... */
  </style>
</head>
<body>
  <!-- 标题 / 控件 / 按钮 / textarea 与之前相同，略 -->

  <script>
    /* ---------- ① GitHub 配置 ---------- */
    const GITHUB_USER = "hsira";             // ← 改成你的用户名
    const GITHUB_REPO = "hsira.github.io";   // ← 改成你的仓库
    const GITHUB_PATH = "";                  // ← txt 所在目录，无则留空

    /* ---------- ② 后备硬编码列表 ---------- */
    const fallbackFiles = [
      "novel1.txt", "part_1.txt", /* ... 你原来那堆 ... */
      "fanren2464.txt"
    ];

    /* ---------- ③ DOM 句柄 ---------- */
    const novelSelect   = document.getElementById("novelSelect");
    const chapterSelect = document.getElementById("chapterSelect");
    const textDisplay   = document.getElementById("textDisplay");
    const timerInput    = document.getElementById("timer");

    /* ---------- ④ 全局状态 ---------- */
    let chapters = [];
    let currentChapter = 0;
    const synth = window.speechSynthesis;
    let utterance = null;
    let endTime = null;

    /* ---------- ⑤ 动态获取文件列表 ---------- */
    async function fetchNovelFiles() {
      const api = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`;
      try {
        const res = await fetch(api);
        if (!res.ok) throw new Error("GitHub API 请求失败");
        const data = await res.json();
        // 过滤 txt
        return data
          .filter(item => item.type === "file" && item.name.endsWith(".txt"))
          .map(item => ({ name: item.name, url: item.download_url }));
      } catch (e) {
        console.warn("⚠️ 使用后备列表，原因：", e.message);
        // 把后备文件名转成相对路径
        return fallbackFiles.map(f => ({ name: f, url: f }));
      }
    }

    /* ---------- ⑥ 初始化下拉框 ---------- */
    async function initNovelSelect() {
      const fileList = await fetchNovelFiles();
      novelSelect.innerHTML = "";
      fileList.forEach((file, i) => {
        const opt = document.createElement("option");
        opt.value = file.url;          // 保存真实 URL
        opt.textContent = file.name;   // 显示文件名
        novelSelect.appendChild(opt);
      });
      // 默认加载第一本
      loadNovel(novelSelect.value);
    }

    novelSelect.addEventListener("change", () => loadNovel(novelSelect.value));
    chapterSelect.addEventListener("change", () => {
      currentChapter = parseInt(chapterSelect.value);
      showChapter(currentChapter);
    });

    /* ---------- ⑦ 加载小说 → 分章节 ---------- */
    async function loadNovel(fileURL) {
      try {
        const res = await fetch(fileURL);
        if (!res.ok) throw new Error("加载失败");
        const text = await res.text();
        splitChapters(text);
        currentChapter = 0;
        chapterSelect.value = 0;
        showChapter(0);
      } catch (e) {
        alert("加载小说失败：" + e.message);
      }
    }

    function splitChapters(text) {
      chapters = [];
      const singleRe = /^第[\u4e00-\u9fa5\d]{1,30}(?:章|回|节|集).*$/;
      const volChapRe= /^第[\u4e00-\u9fa5\d]{1,30}卷.*?第[\u4e00-\u9fa5\d]{1,30}(?:章|回|节|集).*$/;
      const lines = text.split(/\r?\n/);
      let cur = { title: "开始", content: "" };

      for (const raw of lines) {
        const line = raw.trim();
        if (singleRe.test(line) || volChapRe.test(line)) {
          if (cur.content) chapters.push(cur);
          cur = { title: line, content: "" };
        } else {
          cur.content += raw + "\n";
        }
      }
      if (cur.content) chapters.push(cur);
      populateChapterSelect();
    }

    function populateChapterSelect() {
      chapterSelect.innerHTML = "";
      chapters.forEach((c, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = c.title;
        chapterSelect.appendChild(opt);
      });
    }

    function showChapter(i) {
      if (chapters[i]) textDisplay.value = chapters[i].content;
    }

    /* ---------- ⑧ 朗读逻辑（与上一版相同） ---------- */
    function play() {
      if (synth.speaking || synth.pending) synth.cancel();
      const minutes = parseInt(timerInput.value);
      endTime = minutes > 0 ? Date.now() + minutes * 60000 : null;
      speakNextChapter(currentChapter);
    }

    function speakNextChapter(idx) {
      if (endTime && Date.now() >= endTime) { alert("朗读时间已到，已自动停止。"); return; }
      if (!chapters[idx]) return;
      currentChapter = idx;
      chapterSelect.value = idx;
      textDisplay.value = chapters[idx].content;

      utterance = new SpeechSynthesisUtterance(chapters[idx].content);
      utterance.lang = "zh-CN";
      utterance.onend = () => {
        if (!synth.paused && (!endTime || Date.now() < endTime))
          speakNextChapter(idx + 1);
      };
      synth.speak(utterance);
    }

    function pause() { synth.paused ? synth.resume() : synth.pause(); }
    function stop()  { synth.cancel(); endTime = null; }

    /* ---------- ⑨ 启动 ---------- */
    initNovelSelect();
  </script>
</body>
</html>
