<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>听书小助手</title>
  <style>
    body { max-width: 700px; margin: auto; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; padding: 20px;}
    textarea {   width: 100%;   height: 100vh; /* 高度占满整个视口 */   margin-top: 10px;   font-size: 16px;   line-height: 1.5;   padding: 10px;   box-sizing: border-box; }
    select, input, button { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>听书小助手</h1>

  <label for="novelSelect">选择小说：</label>
  <select id="novelSelect"></select>

  <br/>

  <label for="chapterSelect">选择章节：</label>
  <select id="chapterSelect"></select>

  <br/>

  <textarea id="textDisplay" readonly></textarea>

  <br/>

  <label for="timer">定时朗读时间（分钟，0不定时）：</label>
  <input type="number" id="timer" value="0" min="0" />

  <br/>

  <button onclick="play()">播放</button>
  <button onclick="pause()">暂停/继续</button>
  <button onclick="stop()">停止</button>

<script>
  const novelFiles = [
    "novel1.txt",
    "part_1.txt",
    "part_2.txt",
    "part_3.txt",
    "part_4.txt",
    "part_5.txt",
    "part_6.txt",
    "part_7.txt",
    "part_8.txt",
    "part_9.txt",
    "part_10.txt",
    "part_11.txt",
    "part_12.txt",
    "part_13.txt",
    "part_14.txt",
    "part_15.txt",
    "part_16.txt",
    "part_17.txt",
    "part_18.txt",
    "part_19.txt",
    "part_20.txt",
  ];

  const novelSelect = document.getElementById("novelSelect");
  const chapterSelect = document.getElementById("chapterSelect");
  const textDisplay = document.getElementById("textDisplay");
  const timerInput = document.getElementById("timer");

  let chapters = [];
  let currentChapter = 0;
  let synth = window.speechSynthesis;
  let utterance;
  let timer = null;

  // 初始化小说选择列表
  function initNovelSelect() {
    novelFiles.forEach((file, i) => {
      const option = document.createElement("option");
      option.value = file;
      option.textContent = file;
      novelSelect.appendChild(option);
    });
  }

  novelSelect.addEventListener("change", () => {
    loadNovel(novelSelect.value);
  });

  chapterSelect.addEventListener("change", () => {
    currentChapter = parseInt(chapterSelect.value);
    showChapter(currentChapter);
  });

  // 加载小说TXT
  async function loadNovel(fileName) {
    try {
      const response = await fetch(fileName);
      if (!response.ok) throw new Error("加载失败");
      const text = await response.text();
      splitChapters(text);
      currentChapter = 0;
      chapterSelect.value = currentChapter;
      showChapter(currentChapter);
    } catch (e) {
      alert("加载小说失败：" + e.message);
    }
  }

  // 分章节
  function splitChapters(text) {
    chapters = [];
    const lines = text.split(/\r?\n/);
    let current = { title: "开始", content: "" };
    for (let line of lines) {
      if (/^第.{1,9}[章回节].*/.test(line.trim())) {
        if (current.content) chapters.push(current);
        current = { title: line.trim(), content: "" };
      } else {
        current.content += line + "\n";
      }
    }
    if (current.content) chapters.push(current);
    populateChapterSelect();
  }

  // 填充章节选择
  function populateChapterSelect() {
    chapterSelect.innerHTML = "";
    chapters.forEach((chap, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = chap.title;
      chapterSelect.appendChild(opt);
    });
  }

  function showChapter(index) {
    if (chapters[index]) {
      textDisplay.value = chapters[index].content;
    }
  }

  // 朗读控制
  function play() {
    if (synth.speaking) return;
    if (!chapters[currentChapter]) return;
    utterance = new SpeechSynthesisUtterance(chapters[currentChapter].content);
    utterance.lang = "zh-CN";
    synth.speak(utterance);

    if (timer) clearTimeout(timer);
    const minutes = parseInt(timerInput.value);
    if (minutes > 0) {
      timer = setTimeout(() => {
        synth.cancel();
        alert("朗读时间已到，已自动停止。");
      }, minutes * 60000);
    }
  }

  function pause() {
    if (synth.speaking && !synth.paused) {
      synth.pause();
    } else if (synth.paused) {
      synth.resume();
    }
  }

  function stop() {
    synth.cancel();
    if (timer) clearTimeout(timer);
  }

  // 页面初始化
  initNovelSelect();
  // 默认加载第一本小说
  loadNovel(novelFiles[0]);
</script>
</body>
</html>
